<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inspector Dashboard - Water Quality Monitoring</title>
    <style>
        :root {
            /* Light mode variables */
            --bg-color: #f5f5f5;
            --text-color: #333;
            --text-primary: #333;
            --container-bg: rgba(255, 255, 255, 0.95);
            --bg-card: rgba(255, 255, 255, 0.95);
            --container-border: rgba(255, 255, 255, 0.2);
            --input-bg: white;
            --input-border: #ddd;
            --input-text: #000000;
            --card-bg: #f8f9fa;
            --table-border: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --supply-selected-bg: #e3f2fd;
            --supply-text-color: #333;
            --supply-type-color: #666;
            --test-section-bg: #f8f9fa;
            --test-section-border: #e9ecef;
            --positive-color: #28a745;
            --negative-color: #dc3545;
            --muted-text-color: #666;
        }

        [data-theme="dark"] {
            /* Dark mode variables */
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --text-primary: #ffffff;
            --container-bg: rgba(30, 30, 30, 0.95);
            --bg-card: rgba(30, 30, 30, 0.95);
            --container-border: rgba(255, 255, 255, 0.15);
            --input-bg: #2d2d2d;
            --input-border: #555;
            --input-text: #ffffff;
            --card-bg: #252525;
            --table-border: #404040;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --supply-selected-bg: #1e1e1e;
            --supply-text-color: #ffffff;
            --supply-type-color: #cccccc;
            --test-section-bg: #202020;
            --test-section-border: #333;
            --positive-color: #4ade80;
            --negative-color: #f87171;
            --muted-text-color: #a1a1aa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        h1, h2, h3, h4, h5, h6 {
            color: var(--text-color);
        }

        .positive-result {
            color: var(--positive-color) !important;
        }

        .negative-result {
            color: var(--negative-color) !important;
        }

        .muted-text {
            color: var(--muted-text-color) !important;
        }

        /* Dark mode form inputs */
        [data-theme="dark"] .form-group input[type='number'],
        [data-theme="dark"] .form-group input[type='text'],
        [data-theme="dark"] .form-group input[type='date'],
        [data-theme="dark"] .form-group textarea,
        [data-theme="dark"] .form-group select {
            background: #2a2a2a !important;
            color: #ffffff !important;
            border: 2px solid #444 !important;
            font-weight: bold;
        }

        [data-theme="dark"] .form-group input[type='number']:focus,
        [data-theme="dark"] .form-group input[type='text']:focus,
        [data-theme="dark"] .form-group input[type='date']:focus,
        [data-theme="dark"] .form-group textarea:focus,
        [data-theme="dark"] .form-group select:focus {
            background: #333 !important;
            color: #ffffff !important;
            border-color: #667eea !important;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        /* Specific styling for color-coded test result inputs */
        [data-theme="dark"] .positive-value {
            background: #1a4a1a !important;
            color: #90EE90 !important;
            border-color: #28a745 !important;
            font-weight: bold;
        }

        [data-theme="dark"] .negative-value {
            background: #4a1a1a !important;
            color: #FFB6C1 !important;
            border-color: #dc3545 !important;
            font-weight: bold;
        }

        [data-theme="dark"] .pending-value {
            background: #4a4a1a !important;
            color: #FFFFE0 !important;
            border-color: #ffc107 !important;
            font-weight: bold;
        }

        /* Range dropdown styling */
        [data-theme="dark"] .range-dropdown {
            background: #2a2a2a !important;
            color: #ffffff !important;
            border: 2px solid #444 !important;
            font-weight: bold;
        }

        /* Placeholder text styling */
        [data-theme="dark"] .form-group input::placeholder,
        [data-theme="dark"] .form-group textarea::placeholder {
            color: #aaa !important;
            font-weight: normal;
        }

        /* Submit button dark theme */
        [data-theme="dark"] .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            font-weight: bold;
            border: none;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        [data-theme="dark"] .submit-btn:hover {
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
            transform: translateY(-2px);
        }

        /* Form inputs - light mode (default) */
        .form-group input[type='number'],
        .form-group input[type='text'],
        .form-group input[type='date'],
        .form-group textarea,
        .form-group select {
            background: var(--input-bg);
            color: var(--input-text) !important;
            border: 2px solid var(--input-border);
        }

        /* Form inputs - dark mode (enhanced) */
        [data-theme='dark'] .form-group input[type='number'],
        [data-theme='dark'] .form-group input[type='text'],
        [data-theme='dark'] .form-group input[type='date'],
        [data-theme='dark'] .form-group textarea,
        [data-theme='dark'] .form-group select {
            background: #2a2a2a !important;
            color: #ffffff !important;
            border: 2px solid #444 !important;
        }

        /* Color-coded inputs in light mode */
        .positive-value,
        .positive-field {
            background: #d4edda !important;
            color: #155724 !important;
            border-color: #28a745 !important;
        }

        .negative-value,
        .negative-field {
            background: #f8d7da !important;
            color: #721c24 !important;
            border-color: #dc3545 !important;
        }

        .pending-value,
        .pending-field {
            background: #fff3cd !important;
            color: #856404 !important;
            border-color: #ffc107 !important;
        }

        /* Color-coded inputs in dark mode */
        [data-theme='dark'] .positive-value,
        [data-theme='dark'] .positive-field {
            background: #1a4a1a !important;
            color: #90EE90 !important;
            border-color: #4ade80 !important;
        }

        [data-theme='dark'] .negative-value,
        [data-theme='dark'] .negative-field {
            background: #4a1a1a !important;
            color: #FFB6C1 !important;
            border-color: #f87171 !important;
        }

        [data-theme='dark'] .pending-value,
        [data-theme='dark'] .pending-field {
            background: #4a4a1a !important;
            color: #FFFFE0 !important;
            border-color: #fbbf24 !important;
        }

        /* Modal/popup content */
        .modal-content {
            background: var(--container-bg);
            color: var(--text-color);
        }

        .modal-content h2,
        .modal-content h3,
        .modal-content label {
            color: var(--text-color) !important;
        }

        /* Remarks textarea */
        textarea {
            color: var(--text-color) !important;
        }

        [data-theme='dark'] textarea {
            color: #ffffff !important;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .task-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .nav-button {
            position: relative;
            display: inline-block;
        }

        .header h1 {
            font-size: 24px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .form-container {
            background: var(--container-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px var(--shadow-color);
            margin-bottom: 2rem;
            border: 1px solid var(--container-border);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .form-container h2 {
            color: var(--text-color);
            margin-bottom: 1.5rem;
            font-size: 20px;
        }

        .supply-selector {
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-color);
            font-weight: 600;
        }

        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--input-border);
            background: var(--input-bg);
            color: var(--text-color);
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s, background-color 0.3s, color 0.3s;
        }

        .form-group select:focus,
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-text {
            display: block;
            margin-top: 5px;
            font-size: 12px;
            color: #666;
            font-style: italic;
        }

        .selected-supply {
            background: var(--supply-selected-bg);
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1.5rem;
            border-left: 4px solid #667eea;
            transition: background-color 0.3s ease;
        }

        .selected-supply h3 {
            color: var(--supply-text-color);
            font-size: 18px;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .selected-supply p {
            color: var(--supply-type-color);
            font-size: 14px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .input-with-button {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-with-button input {
            flex: 1;
        }

        .input-with-dropdown {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .count-input {
            width: 120px !important;
            flex: none;
        }

        .range-dropdown {
            width: 80px !important;
            flex: none;
            min-width: 80px;
        }

        .increment-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            white-space: nowrap;
        }

        .increment-btn:hover {
            background: #218838;
        }

        .test-section {
            background: var(--test-section-bg);
            border: 1px solid var(--test-section-border);
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .test-section h3 {
            color: var(--text-color);
            margin-bottom: 1rem;
            font-size: 16px;
        }

        .test-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }

        .chlorine-total {
            background: #f8f9fa !important;
            color: #666 !important;
            cursor: not-allowed;
        }

        /* Color coding for test results */
        .positive-field {
            background: #d4edda !important;
            border-color: #28a745 !important;
        }

        .negative-field {
            background: #f8d7da !important;
            border-color: #dc3545 !important;
        }

        .pending-field {
            background: #fff3cd !important;
            border-color: #ffc107 !important;
        }

        .warning-text {
            color: #dc3545;
            font-weight: bold;
            font-size: 12px;
            margin-top: 5px;
        }

        .ideal-range {
            color: #28a745;
            font-weight: bold;
            font-size: 12px;
            margin-top: 5px;
        }

        .maximum-level {
            color: #fd7e14;
            font-weight: bold;
            font-size: 12px;
            margin-top: 5px;
        }

        .high-level {
            color: #dc3545;
            font-weight: bold;
            font-size: 12px;
            margin-top: 5px;
        }

        .very-high-level {
            color: #721c24;
            font-weight: bold;
            font-size: 12px;
            margin-top: 5px;
        }

        .urgent-icon {
            color: #dc3545;
            font-size: 18px;
            margin-left: 5px;
            vertical-align: middle;
        }

        .organism-dropdown {
            width: 150px !important;
            margin-left: 10px;
        }

        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .alert {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none;
        }

        .treated-only {
            opacity: 0.6;
        }

        .recent-submissions {
            background: var(--container-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px var(--shadow-color);
            border: 1px solid var(--container-border);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .search-container {
            position: relative;
            margin-bottom: 2rem;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 14px;
            background: #f8f9fa;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-size: 16px;
        }

        .clear-search {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 16px;
            display: none;
        }

        .clear-search:hover {
            color: #333;
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }

        .suggestion-item:hover {
            background: #f8f9fa;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-type {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .suggestion-name {
            font-weight: 600;
            color: #333;
        }

        .suggestion-details {
            font-size: 12px;
            color: #666;
        }

        .no-results {
            text-align: center;
            color: #666;
            padding: 2rem;
            font-style: italic;
        }

        .submission-card {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
            transition: background-color 0.3s ease;
        }

        .submission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .submission-time {
            color: var(--supply-type-color);
            font-size: 12px;
        }

        /* Task Management Styles */
        .task-management {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .task-card {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
            position: relative;
        }

        .task-card.urgent {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .task-card.high {
            border-left-color: #fd7e14;
            background: #fff8f1;
        }

        .task-card.medium {
            border-left-color: #ffc107;
            background: #fffbf0;
        }

        .task-card.low {
            border-left-color: #28a745;
            background: #f8fff9;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .task-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0 0 0.5rem 0;
        }

        .task-priority {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .task-priority.urgent {
            background: #dc3545;
            color: white;
        }

        .task-priority.high {
            background: #fd7e14;
            color: white;
        }

        .task-priority.medium {
            background: #ffc107;
            color: #333;
        }

        .task-priority.low {
            background: #28a745;
            color: white;
        }

        .task-description {
            color: #666;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .task-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
            font-size: 14px;
        }

        .task-detail {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .task-detail strong {
            color: #333;
        }

        .task-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .task-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .task-btn.accept {
            background: #28a745;
            color: white;
        }

        .task-btn.accept:hover {
            background: #218838;
        }

        .task-btn.reject {
            background: #dc3545;
            color: white;
        }

        .task-btn.reject:hover {
            background: #c82333;
        }

        .task-btn.view {
            background: #007bff;
            color: white;
        }

        .task-btn.view:hover {
            background: #0056b3;
        }

        .task-btn.complete {
            background: #17a2b8;
            color: white;
        }

        .task-btn.complete:hover {
            background: #138496;
        }

        .task-status {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .task-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .task-status.accepted {
            background: #d4edda;
            color: #155724;
        }

        .task-status.in_progress {
            background: #d1ecf1;
            color: #0c5460;
        }

        .task-status.completed {
            background: #d4edda;
            color: #155724;
        }

        .task-status.rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .no-tasks {
            text-align: center;
            color: #666;
            padding: 3rem;
            font-style: italic;
        }

        .task-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            z-index: 1000;
            display: none;
            animation: slideInTask 0.3s ease-out;
        }

        @keyframes slideInTask {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        .filter-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .filter-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .filter-tab:hover:not(.active) {
            background: #f8f9fa;
        }

        /* Water-themed Success Modal */
        .water-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, rgba(6, 19, 35, 0.95) 0%, rgba(0, 5, 15, 0.98) 100%);
            backdrop-filter: blur(12px);
            opacity: 0;
            transition: opacity 0.4s ease-out;
            overflow: hidden;
            align-items: center;
            justify-content: center;
        }

        .water-modal.show {
            opacity: 1;
        }

        .water-modal-content {
            background: linear-gradient(135deg,
                rgba(15, 30, 55, 0.95) 0%,
                rgba(25, 40, 65, 0.9) 50%,
                rgba(35, 50, 75, 0.95) 100%);
            margin: 2% auto;
            padding: 0;
            border: 2px solid rgba(0, 150, 255, 0.4);
            border-radius: 30px;
            width: 95%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
            box-shadow:
                0 30px 60px rgba(0, 100, 200, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 0 0 1px rgba(0, 150, 255, 0.2);
            position: relative;
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 150, 255, 0.5) transparent;
            transform: scale(0.8) translateY(-20px);
            transition: transform 0.4s ease-out, opacity 0.4s ease-out;
        }

        .water-modal.show .water-modal-content {
            transform: scale(1) translateY(0);
        }

        .water-modal-content::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg,
                transparent,
                rgba(0, 150, 255, 0.5),
                rgba(0, 200, 255, 0.7),
                rgba(0, 150, 255, 0.5),
                transparent);
            border-radius: 30px;
            animation: borderFlow 4s linear infinite;
            z-index: -1;
        }

        .water-modal-header {
            background: linear-gradient(135deg,
                rgba(0, 120, 255, 0.9) 0%,
                rgba(0, 80, 200, 0.95) 50%,
                rgba(0, 60, 150, 0.9) 100%);
            padding: 3rem 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            border-bottom: 2px solid rgba(0, 150, 255, 0.3);
        }

        .water-modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent);
            animation: headerScan 5s ease-in-out infinite;
        }

        .water-modal-header::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 20%, rgba(0, 200, 255, 0.4) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0, 150, 255, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(0, 180, 255, 0.2) 0%, transparent 70%);
            animation: particleFloat 8s ease-in-out infinite;
        }

        .water-modal-header h2 {
            color: #ffffff;
            margin: 0;
            font-size: 2.4rem;
            font-weight: 300;
            text-shadow:
                0 0 20px rgba(0, 150, 255, 0.6),
                0 0 40px rgba(0, 200, 255, 0.3),
                0 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 3;
            letter-spacing: 2px;
            font-family: 'Segoe UI', sans-serif;
            text-transform: uppercase;
        }

        .water-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
            animation: waterDrop 2s ease-in-out infinite;
            position: relative;
            z-index: 2;
        }

        .water-modal-body {
            padding: 3rem 2.5rem;
            text-align: center;
            background: linear-gradient(135deg,
                rgba(15, 25, 40, 0.95) 0%,
                rgba(20, 30, 45, 0.9) 100%);
            position: relative;
            color: #ffffff;
            border-radius: 0 0 30px 30px;
        }

        .water-modal-body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 150, 255, 0.03) 2px,
                    rgba(0, 150, 255, 0.03) 4px
                );
            animation: scanLines 3s linear infinite;
        }

        .water-message {
            font-size: 1.6rem;
            font-weight: 300;
            margin-bottom: 2rem;
            color: #e8f4f8;
            text-shadow: 0 0 20px rgba(0, 150, 255, 0.4);
            line-height: 1.6;
            position: relative;
            z-index: 2;
        }

        .water-submessage {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 2.5rem;
            line-height: 1.6;
            position: relative;
            z-index: 2;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
            position: relative;
            z-index: 2;
        }

        .analysis-item {
            background: linear-gradient(135deg,
                rgba(0, 150, 255, 0.15) 0%,
                rgba(0, 100, 200, 0.1) 100%);
            border: 1px solid rgba(0, 150, 255, 0.3);
            border-radius: 15px;
            padding: 1.5rem 1rem;
            text-align: center;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .analysis-item::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(
                from 0deg,
                transparent,
                rgba(0, 150, 255, 0.1),
                transparent
            );
            animation: hologramRotate 6s linear infinite;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .analysis-item:hover::before {
            opacity: 1;
        }

        .analysis-item:hover {
            border-color: rgba(0, 150, 255, 0.6);
            box-shadow:
                0 8px 25px rgba(0, 150, 255, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transform: translateY(-5px) scale(1.02);
        }

        .analysis-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: #00e5ff;
            text-shadow:
                0 0 15px rgba(0, 229, 255, 0.5),
                0 0 30px rgba(0, 200, 255, 0.3);
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 2;
            word-wrap: break-word;
            text-align: center;
        }

        .status-success {
            color: #00ff88 !important;
            text-shadow:
                0 0 15px rgba(0, 255, 136, 0.6),
                0 0 30px rgba(0, 200, 100, 0.4) !important;
        }

        .status-verified {
            color: #ffd700 !important;
            text-shadow:
                0 0 15px rgba(255, 215, 0, 0.6),
                0 0 30px rgba(255, 193, 7, 0.4) !important;
        }

        .analysis-summary {
            margin: 1.5rem 0;
            padding: 1rem;
            background: rgba(10, 25, 45, 0.6);
            border: 1px solid rgba(0, 150, 255, 0.3);
            border-radius: 8px;
            backdrop-filter: blur(5px);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0.5rem 0;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(0, 150, 255, 0.2);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 600;
            letter-spacing: 1px;
        }

        .summary-value {
            font-size: 0.9rem;
            color: #00e5ff;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 229, 255, 0.4);
        }

        .header-particles .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #00e5ff;
            border-radius: 50%;
            animation: particleFloat 4s infinite linear;
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.8);
        }

        .header-particles .particle:nth-child(1) {
            top: 20%;
            left: 20%;
            animation-delay: 0s;
        }

        .header-particles .particle:nth-child(2) {
            top: 60%;
            left: 80%;
            animation-delay: 1s;
        }

        .header-particles .particle:nth-child(3) {
            top: 40%;
            left: 60%;
            animation-delay: 2s;
        }

        .header-scanline {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00e5ff, transparent);
            animation: headerScan 3s infinite;
        }

        .header-status {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            letter-spacing: 1px;
            margin-top: 0.5rem;
        }

        .tech-button {
            position: relative;
            overflow: hidden;
            border: 2px solid #00e5ff !important;
            background: linear-gradient(135deg, rgba(0, 229, 255, 0.2), rgba(0, 150, 255, 0.4)) !important;
            color: #ffffff !important;
            padding: 1.2rem 2.5rem !important;
            font-size: 1.1rem !important;
            font-weight: bold;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px !important;
            margin-top: 1.5rem;
            width: auto;
            max-width: none;
            display: inline-block;
            z-index: 10;
        }

        .tech-button:hover {
            background: linear-gradient(135deg, rgba(0, 229, 255, 0.4), rgba(0, 150, 255, 0.6)) !important;
            box-shadow:
                0 0 25px rgba(0, 229, 255, 0.6),
                inset 0 0 20px rgba(0, 229, 255, 0.2) !important;
            transform: scale(1.05) translateY(-2px);
            border-color: #00f5ff !important;
        }

        .button-text {
            position: relative;
            z-index: 2;
            font-weight: bold;
            font-size: 1.1rem;
            text-shadow: 0 0 10px rgba(0, 229, 255, 0.3);
            display: inline-block;
        }

        .button-scan {
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 229, 255, 0.3), transparent);
            animation: scanLines 2s infinite;
        }

        .analysis-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            z-index: 2;
            text-align: center;
            line-height: 1.2;
        }

        .water-close-btn {
            background: linear-gradient(135deg,
                rgba(0, 150, 255, 0.8) 0%,
                rgba(0, 100, 200, 0.9) 100%);
            border: 2px solid rgba(0, 150, 255, 0.5);
            color: white;
            padding: 1rem 2.5rem;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            z-index: 2;
            margin-top: 1.5rem;
        }

        .water-close-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent);
            transition: left 0.5s ease;
        }

        .water-close-btn:hover::before {
            left: 100%;
        }

        .water-close-btn:hover {
            box-shadow:
                0 5px 20px rgba(0, 150, 255, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .water-close-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .ocean-bubbles {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .bubble {
            position: absolute;
            background: radial-gradient(circle, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.4) 70%, rgba(255,255,255,0.1) 100%);
            border-radius: 50%;
            animation: bubbleRise 4s ease-in-out infinite;
            opacity: 0.8;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .bubble:nth-child(1) { left: 15%; animation-delay: 0s; width: 20px; height: 20px; animation-duration: 3.5s; }
        .bubble:nth-child(2) { left: 35%; animation-delay: 0.8s; width: 15px; height: 15px; animation-duration: 4.2s; }
        .bubble:nth-child(3) { left: 60%; animation-delay: 1.5s; width: 25px; height: 25px; animation-duration: 3.8s; }
        .bubble:nth-child(4) { left: 80%; animation-delay: 2.2s; width: 12px; height: 12px; animation-duration: 4.5s; }
        .bubble:nth-child(5) { left: 25%; animation-delay: 3s; width: 18px; height: 18px; animation-duration: 3.2s; }
        .bubble:nth-child(6) { left: 45%; animation-delay: 0.3s; width: 10px; height: 10px; animation-duration: 4.8s; }
        .bubble:nth-child(7) { left: 70%; animation-delay: 1.8s; width: 22px; height: 22px; animation-duration: 3.6s; }
        .bubble:nth-child(8) { left: 90%; animation-delay: 2.5s; width: 14px; height: 14px; animation-duration: 4.1s; }
        .bubble:nth-child(9) { left: 5%; animation-delay: 1.2s; width: 16px; height: 16px; animation-duration: 4.3s; }
        .bubble:nth-child(10) { left: 85%; animation-delay: 0.7s; width: 8px; height: 8px; animation-duration: 3.9s; }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes waterDrop {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes waterShimmer {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(5deg); }
        }

        @keyframes waterFlow {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes borderFlow {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes headerScan {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: -100%; }
        }

        @keyframes particleFloat {
            0%, 100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.3;
            }
            25% {
                transform: translate(10px, -5px) scale(1.1);
                opacity: 0.6;
            }
            50% {
                transform: translate(-5px, -10px) scale(0.9);
                opacity: 0.4;
            }
            75% {
                transform: translate(-10px, 5px) scale(1.05);
                opacity: 0.5;
            }
        }

        @keyframes scanLines {
            0% { transform: translateY(0); }
            100% { transform: translateY(4px); }
        }

        @keyframes hologramRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes bubbleRise {
            0% {
                bottom: -30px;
                opacity: 0;
                transform: translateX(0) scale(0.8);
            }
            10% {
                opacity: 0.8;
            }
            50% {
                transform: translateX(10px) scale(1);
            }
            90% {
                opacity: 0.8;
            }
            100% {
                bottom: 100%;
                opacity: 0;
                transform: translateX(-10px) scale(1.2);
            }
        }
    </style>
</head>
<body>
    <!-- Water-themed Success Modal -->
    <div id="waterModal" class="water-modal">
        <div class="water-modal-content">
            <div class="water-modal-header">
                <div class="header-particles">
                    <div class="particle"></div>
                    <div class="particle"></div>
                    <div class="particle"></div>
                </div>
                <div class="header-scanline"></div>
                <h2>WATER ANALYSIS COMPLETE</h2>
                <div class="header-status">SYSTEM STATUS: OPERATIONAL</div>
            </div>
            <div class="water-modal-body">
                <div class="analysis-grid">
                    <div class="analysis-item">
                        <div class="analysis-label">INSPECTION STATUS</div>
                        <div class="analysis-value status-success">SUBMITTED</div>
                    </div>
                    <div class="analysis-item">
                        <div class="analysis-label">DATA INTEGRITY</div>
                        <div class="analysis-value status-verified">VERIFIED</div>
                    </div>
                    <div class="analysis-item">
                        <div class="analysis-label">TIMESTAMP</div>
                        <div class="analysis-value" id="analysis-timestamp">--:--:--</div>
                    </div>
                    <div class="analysis-item">
                        <div class="analysis-label">TRANSMISSION</div>
                        <div class="analysis-value status-success">SUCCESSFUL</div>
                    </div>
                </div>

                <div class="water-message" id="waterModalMessage">
                    INSPECTION DATA SUCCESSFULLY TRANSMITTED TO CENTRAL DATABASE
                </div>

                <div class="analysis-summary">
                    <div class="summary-item">
                        <span class="summary-label">CHLORINE ANALYSIS:</span>
                        <span class="summary-value" id="chlorine-summary">PROCESSED</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">BACTERIOLOGICAL:</span>
                        <span class="summary-value" id="bacteria-summary">PROCESSED</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">SUPPLY STATUS:</span>
                        <span class="summary-value" id="supply-summary">MONITORED</span>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 2rem;">
                    <button class="water-close-btn tech-button" onclick="closeWaterModalWithFade()" style="box-shadow: 0 0 30px rgba(0, 229, 255, 0.5) !important;">
                        <span class="button-text">CONTINUE TO DASHBOARD</span>
                        <div class="button-scan"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="header">
        <h1>Westmoreland Inspector Dashboard</h1>
        <div class="user-info">
            <span id="welcomeText">Welcome, Inspector</span>
            <div class="nav-button">
                <button id="assignedTasksBtn" class="logout-btn" style="background: rgba(255, 255, 255, 0.3); margin-right: 10px;">📋 Assigned Tasks</button>
                <span id="taskBadge" class="task-badge" style="display: none;">0</span>
            </div>
            <button onclick="window.open('https://www.wrha.gov.jm/', '_blank')" class="logout-btn" style="background: rgba(255, 255, 255, 0.3); margin-right: 10px;">🌐 Connect on WRHA Hub</button>
            <button id="darkModeToggle" class="logout-btn" style="background: rgba(255, 255, 255, 0.3); margin-right: 10px;">🌙 Dark Mode</button>
            <a href="/logout" class="logout-btn">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="form-container">
            <h2>New Water Quality Submission</h2>

            <div id="alert-container"></div>

            <div class="supply-selector">
                <div class="form-group">
                    <label for="supply">Select Water Supply</label>
                    <select id="supply" name="supply_id">
                        <option value="">Select a water supply...</option>
                    </select>
                </div>

                <div id="facility-type-group" class="form-group hidden">
                    <label for="facility-type">MOH Facility Type</label>
                    <select id="facility-type">
                        <option value="">Select facility type...</option>
                        <option value="Health Center">Health Center</option>
                        <option value="Hospital">Hospital</option>
                        <option value="Commercial Building">Commercial Building</option>
                    </select>
                </div>
            </div>

            <div id="submission-form-section" class="hidden">
                <div class="selected-supply">
                    <h3 id="selected-supply-name"></h3>
                    <p id="selected-supply-info"></p>

                    <div id="sampling-points-section" class="hidden">
                        <div class="form-group">
                            <label for="sampling-point">Select Sampling Point</label>
                            <select id="sampling-point" name="sampling_point_id">
                                <option value="">Select a sampling point (optional)...</option>
                            </select>
                            <small class="form-text">Location: <span id="sampling-point-location"></span></small>
                        </div>
                        <div class="form-group">
                            <label for="water-source-type">Water Source Type</label>
                            <select id="water-source-type" name="water_source_type">
                                <option value="">Select source type...</option>
                                <option value="well">Well</option>
                                <option value="river">River</option>
                                <option value="spring">Spring</option>
                                <option value="catchment">Catchment</option>
                                <option value="reservoir">Reservoir</option>
                                <option value="tank">Tank</option>
                                <option value="plant">Treatment Plant</option>
                                <option value="standpipe">Standpipe</option>
                                <option value="tap">Tap</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                </div>

                <form id="submission-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="visits">Number of Visits</label>
                            <div class="input-with-button">
                                <input type="number" id="visits" name="visits" min="1" value="1">
                                <button type="button" class="increment-btn" onclick="incrementVisits()">+1 Visit</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="submission-date">Submission Date</label>
                            <input type="date" id="submission-date" name="submission_date" required>
                        </div>
                    </div>

                    <div class="test-section" id="chlorine-section">
                        <h3>Chlorine Residual Tests (Treated Supplies Only)</h3>
                        <div class="test-inputs">
                            <div class="form-group">
                                <label for="chlorine-total">Total Tests</label>
                                <input type="number" id="chlorine-total" name="chlorine_total" min="0" value="0" readonly class="chlorine-total">
                            </div>
                            <div class="form-group">
                                <label for="chlorine-positive">Positive</label>
                                <div class="input-with-dropdown">
                                    <input type="number" id="chlorine-positive" name="chlorine_positive" min="0" value="0" class="positive-field count-input">
                                    <select id="chlorine-positive-range" name="chlorine_positive_range" class="range-dropdown">
                                        <option value="">Range</option>
                                        <option value="0">0</option>
                                        <option value="0.1">0.1</option>
                                        <option value="0.2">0.2</option>
                                        <option value="0.3">0.3</option>
                                        <option value="0.4">0.4</option>
                                        <option value="0.5">0.5</option>
                                        <option value="0.6">0.6</option>
                                        <option value="0.7">0.7</option>
                                        <option value="0.8">0.8</option>
                                        <option value="0.9">0.9</option>
                                        <option value="1.0">1.0</option>
                                        <option value="1.1">1.1</option>
                                        <option value="1.2">1.2</option>
                                        <option value="1.3">1.3</option>
                                        <option value="1.4">1.4</option>
                                        <option value="1.5">1.5</option>
                                        <option value="1.6">1.6</option>
                                        <option value="1.7">1.7</option>
                                        <option value="1.8">1.8</option>
                                        <option value="1.9">1.9</option>
                                        <option value="2.0">2.0</option>
                                        <option value="2.1">2.1</option>
                                        <option value="2.2">2.2</option>
                                        <option value="2.3">2.3</option>
                                        <option value="2.4">2.4</option>
                                        <option value="2.5">2.5</option>
                                        <option value="2.6">2.6</option>
                                        <option value="2.7">2.7</option>
                                        <option value="2.8">2.8</option>
                                        <option value="2.9">2.9</option>
                                        <option value="3.0">3.0</option>
                                        <option value=">3.5">&gt;3.5</option>
                                    </select>
                                </div>
                                <div id="chlorine-positive-warning" class="warning-text" style="display: none;">Low chlorine level - action needed</div>
                                <div id="chlorine-positive-ideal" class="ideal-range" style="display: none;">Ideal level</div>
                                <div id="chlorine-positive-maximum" class="maximum-level" style="display: none;">Maximum level</div>
                                <div id="chlorine-positive-high" class="high-level" style="display: none;">High level - adjust chlorine dosage</div>
                                <div id="chlorine-positive-very-high" class="very-high-level" style="display: none;">Very high level - adjust chlorine dosage</div>
                            </div>
                            <div class="form-group">
                                <label for="chlorine-negative">Negative</label>
                                <div class="input-with-dropdown">
                                    <input type="number" id="chlorine-negative" name="chlorine_negative" min="0" value="0" class="negative-field count-input">
                                    <select id="chlorine-negative-range" name="chlorine_negative_range" class="range-dropdown">
                                        <option value="">Range</option>
                                        <option value="0">0</option>
                                        <option value="0.1">0.1</option>
                                        <option value="0.2">0.2</option>
                                        <option value="0.3">0.3</option>
                                        <option value="0.4">0.4</option>
                                        <option value="0.5">0.5</option>
                                        <option value="0.6">0.6</option>
                                        <option value="0.7">0.7</option>
                                        <option value="0.8">0.8</option>
                                        <option value="0.9">0.9</option>
                                        <option value="1.0">1.0</option>
                                        <option value="1.1">1.1</option>
                                        <option value="1.2">1.2</option>
                                        <option value="1.3">1.3</option>
                                        <option value="1.4">1.4</option>
                                        <option value="1.5">1.5</option>
                                        <option value="1.6">1.6</option>
                                        <option value="1.7">1.7</option>
                                        <option value="1.8">1.8</option>
                                        <option value="1.9">1.9</option>
                                        <option value="2.0">2.0</option>
                                        <option value="2.1">2.1</option>
                                        <option value="2.2">2.2</option>
                                        <option value="2.3">2.3</option>
                                        <option value="2.4">2.4</option>
                                        <option value="2.5">2.5</option>
                                        <option value="2.6">2.6</option>
                                        <option value="2.7">2.7</option>
                                        <option value="2.8">2.8</option>
                                        <option value="2.9">2.9</option>
                                        <option value="3.0">3.0</option>
                                        <option value=">3.5">&gt;3.5</option>
                                    </select>
                                </div>
                                <div id="chlorine-negative-warning" class="warning-text" style="display: none;">Low chlorine level - action needed</div>
                                <div id="chlorine-negative-ideal" class="ideal-range" style="display: none;">Ideal level</div>
                                <div id="chlorine-negative-maximum" class="maximum-level" style="display: none;">Maximum level</div>
                                <div id="chlorine-negative-high" class="high-level" style="display: none;">High level - adjust chlorine dosage</div>
                                <div id="chlorine-negative-very-high" class="very-high-level" style="display: none;">Very high level - adjust chlorine dosage</div>
                            </div>
                        </div>
                    </div>

                    <div class="test-section">
                        <h3>Bacteriological Tests</h3>
                        <div class="test-inputs">
                            <div class="form-group">
                                <label for="bacteriological-positive">Positive</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="number" id="bacteriological-positive" name="bacteriological_positive" min="0" value="0" class="positive-field count-input">
                                    <span id="urgent-icon" class="urgent-icon" style="display: none;">⚠️</span>
                                    <select id="isolated-organism" name="isolated_organism" class="organism-dropdown" style="display: none;">
                                        <option value="">Select organism</option>
                                        <option value="E. coli">E. coli</option>
                                        <option value="Coliform">Coliform</option>
                                        <option value="Enterococcus">Enterococcus</option>
                                        <option value="Salmonella">Salmonella</option>
                                        <option value="Shigella">Shigella</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="bacteriological-negative">Negative</label>
                                <input type="number" id="bacteriological-negative" name="bacteriological_negative" min="0" value="0" class="negative-field">
                            </div>
                            <div class="form-group">
                                <label for="bacteriological-pending">Result Pending</label>
                                <input type="number" id="bacteriological-pending" name="bacteriological_pending" min="0" value="0" class="pending-field">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="remarks">Remarks</label>
                        <textarea id="remarks" name="remarks" rows="3" placeholder="Enter any additional observations or remarks..."></textarea>
                    </div>

                    <button type="submit" class="submit-btn" id="submit-btn">Submit New Inspection Data</button>
                </form>
            </div>
        </div>

        <div class="recent-submissions">
            <h2>Your Recent Submissions</h2>

            <div class="search-container">
                <span class="search-icon">🔍</span>
                <input type="text" id="search-input" class="search-input" placeholder="Search by water supply or sampling point...">
                <button id="clear-search" class="clear-search">✕</button>
                <div id="search-suggestions" class="search-suggestions"></div>
            </div>

            <div id="recent-submissions-list">
                <p>No recent submissions</p>
            </div>
        </div>
    </div>

    <script>
        // Dark Mode Functionality
        class ThemeManager {
            constructor() {
                this.currentTheme = localStorage.getItem('theme') || 'light';
                this.toggleButton = null;
            }

            init() {
                this.toggleButton = document.getElementById('darkModeToggle');
                this.applyTheme(this.currentTheme);
                this.setupEventListeners();
            }

            setupEventListeners() {
                if (this.toggleButton) {
                    this.toggleButton.addEventListener('click', () => {
                        this.toggleTheme();
                    });
                }
            }

            toggleTheme() {
                this.currentTheme = this.currentTheme === 'light' ? 'dark' : 'light';
                this.applyTheme(this.currentTheme);
                localStorage.setItem('theme', this.currentTheme);
            }

            applyTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                if (this.toggleButton) {
                    if (theme === 'dark') {
                        this.toggleButton.innerHTML = '☀️ Light Mode';
                    } else {
                        this.toggleButton.innerHTML = '🌙 Dark Mode';
                    }
                }
            }
        }

        class InspectorDashboard {
            constructor() {
                this.supplies = [];
                this.currentSupply = null;
                this.recentSubmissions = [];
                this.filteredSubmissions = [];
                this.searchTimeout = null;
                this.assignedTasks = [];
                this.filteredTasks = [];
                this.currentFilter = 'all';
                this.init();
            }

            async init() {
                await this.loadSupplies();
                this.setupEventListeners();
                await this.loadRecentSubmissions();
                this.setTodayDate();
                // Load tasks initially to show badge
                await this.loadAssignedTasks();
            }

            async loadSupplies() {
                try {
                    const response = await fetch('/api/supplies');
                    if (response.ok) {
                        this.supplies = await response.json();
                        this.populateSuppliesDropdown();
                    } else {
                        this.showAlert('error', 'Failed to load water supplies');
                    }
                } catch (error) {
                    console.error('Error loading supplies:', error);
                    this.showAlert('error', 'Error connecting to server');
                }
            }

            populateSuppliesDropdown() {
                const supplySelect = document.getElementById('supply');
                supplySelect.innerHTML = '<option value="">Select a water supply...</option>';

                // Group supplies by type
                const treatedSupplies = this.supplies.filter(s => s.type === 'treated');
                const untreatedSupplies = this.supplies.filter(s => s.type === 'untreated');

                // Add treated supplies group
                if (treatedSupplies.length > 0) {
                    const treatedGroup = document.createElement('optgroup');
                    treatedGroup.label = 'Treated Supplies';
                    treatedSupplies.forEach(supply => {
                        const option = document.createElement('option');
                        option.value = supply.id;
                        option.textContent = `${supply.name} (${supply.agency})`;
                        treatedGroup.appendChild(option);
                    });
                    supplySelect.appendChild(treatedGroup);
                }

                // Add untreated supplies group
                if (untreatedSupplies.length > 0) {
                    const untreatedGroup = document.createElement('optgroup');
                    untreatedGroup.label = 'Untreated Supplies';
                    untreatedSupplies.forEach(supply => {
                        const option = document.createElement('option');
                        option.value = supply.id;
                        option.textContent = `${supply.name} (${supply.agency})`;
                        untreatedGroup.appendChild(option);
                    });
                    supplySelect.appendChild(untreatedGroup);
                }

                // Add "Other Governments" option
                const otherGovGroup = document.createElement('optgroup');
                otherGovGroup.label = 'Other Options';
                const otherGovOption = document.createElement('option');
                otherGovOption.value = 'other-governments';
                otherGovOption.textContent = 'Other Governments';
                otherGovGroup.appendChild(otherGovOption);
                supplySelect.appendChild(otherGovGroup);
            }

            setupEventListeners() {
                const form = document.getElementById('submission-form');
                form.addEventListener('submit', this.handleSubmit.bind(this));

                // Prevent form submission on Enter key press in any input field
                form.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' && event.target.tagName !== 'BUTTON' && event.target.type !== 'submit') {
                        event.preventDefault();
                        return false;
                    }
                });

                document.getElementById('supply').addEventListener('change', this.handleSupplySelection.bind(this));

                document.getElementById('sampling-point').addEventListener('change', this.handleSamplingPointSelection.bind(this));

                // Auto-calculate chlorine totals and handle range warnings
                ['chlorine-positive', 'chlorine-negative'].forEach(id => {
                    document.getElementById(id).addEventListener('input', this.updateChlorineTotal.bind(this));
                });

                // Handle chlorine range change events for warnings
                ['chlorine-positive-range', 'chlorine-negative-range'].forEach(id => {
                    document.getElementById(id).addEventListener('change', this.handleChlorineRangeChange.bind(this));
                });

                // Handle bacteriological positive input for urgent warnings
                document.getElementById('bacteriological-positive').addEventListener('input', this.handleBacteriologicalChange.bind(this));

                // Search functionality
                this.setupSearchListeners();

                // Task filter functionality
                this.setupTaskFilters();
            }

            setTodayDate() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('submission-date').value = today;
            }

            handleSupplySelection() {
                const supplyId = document.getElementById('supply').value;
                if (!supplyId) {
                    this.hideForm();
                    return;
                }

                // Handle "Other Governments" option
                if (supplyId === 'other-governments') {
                    this.currentSupply = {
                        id: 'other-governments',
                        name: 'Other Governments',
                        agency: 'Other Government Agency',
                        type: 'treated' // Default to treated for chlorine calculations
                    };

                    // Update form title
                    document.getElementById('selected-supply-name').textContent = 'Other Governments';
                    document.getElementById('selected-supply-info').textContent = 'Other Government Agency • Treated';
                } else {
                    const supply = this.supplies.find(s => s.id == supplyId);
                    this.currentSupply = supply;

                    // Update form title
                    document.getElementById('selected-supply-name').textContent = supply ? supply.name : '';
                    document.getElementById('selected-supply-info').textContent = supply ? `${supply.agency} • ${supply.type.charAt(0).toUpperCase() + supply.type.slice(1)}` : '';
                }

                // Show/hide facility type dropdown for MOH supplies
                const facilityTypeGroup = document.getElementById('facility-type-group');
                if (this.currentSupply && this.currentSupply.agency === 'MOH') {
                    facilityTypeGroup.classList.remove('hidden');
                } else {
                    facilityTypeGroup.classList.add('hidden');
                    document.getElementById('facility-type').value = '';
                }

                // Handle chlorine section for treated vs untreated supplies
                const chlorineSection = document.getElementById('chlorine-section');
                if (this.currentSupply && this.currentSupply.type === 'untreated') {
                    chlorineSection.classList.add('treated-only');
                    // Clear and disable chlorine inputs for untreated supplies
                    document.getElementById('chlorine-total').value = 0;
                    document.getElementById('chlorine-positive').value = 0;
                    document.getElementById('chlorine-negative').value = 0;
                    document.getElementById('chlorine-positive-range').value = '';
                    document.getElementById('chlorine-negative-range').value = '';
                    document.getElementById('chlorine-positive').disabled = true;
                    document.getElementById('chlorine-negative').disabled = true;
                    document.getElementById('chlorine-positive-range').disabled = true;
                    document.getElementById('chlorine-negative-range').disabled = true;
                } else {
                    chlorineSection.classList.remove('treated-only');
                    document.getElementById('chlorine-positive').disabled = false;
                    document.getElementById('chlorine-negative').disabled = false;
                    document.getElementById('chlorine-positive-range').disabled = false;
                    document.getElementById('chlorine-negative-range').disabled = false;
                }

                // Load sampling points for this supply
                this.loadSamplingPoints(supplyId);

                // Show the form
                document.getElementById('submission-form-section').classList.remove('hidden');
            }

            hideForm() {
                document.getElementById('selected-supply-name').textContent = '';
                document.getElementById('selected-supply-info').textContent = '';
                document.getElementById('submission-form-section').classList.add('hidden');
                document.getElementById('facility-type-group').classList.add('hidden');
                this.resetForm();
            }

            resetForm() {
                // Reset all form values to defaults
                document.getElementById('visits').value = 1;
                document.getElementById('chlorine-total').value = 0;
                document.getElementById('chlorine-positive').value = 0;
                document.getElementById('chlorine-negative').value = 0;
                document.getElementById('chlorine-positive-range').value = '';
                document.getElementById('chlorine-negative-range').value = '';
                document.getElementById('bacteriological-positive').value = 0;
                document.getElementById('bacteriological-negative').value = 0;
                document.getElementById('bacteriological-pending').value = 0;
                document.getElementById('facility-type').value = '';
                document.getElementById('remarks').value = '';

                // Re-enable all inputs
                document.querySelectorAll('#submission-form input, #submission-form textarea, #submission-form select').forEach(input => {
                    input.disabled = false;
                });

                document.getElementById('chlorine-section').classList.remove('treated-only');
                this.setTodayDate();

                // Reset sampling points
                this.hideSamplingPoints();
            }

            async loadSamplingPoints(supplyId) {
                try {
                    const response = await fetch(`/api/sampling-points/${supplyId}`);
                    if (response.ok) {
                        const samplingPoints = await response.json();
                        if (samplingPoints.length > 0) {
                            this.populateSamplingPointsDropdown(samplingPoints);
                            this.showSamplingPoints();
                        } else {
                            this.hideSamplingPoints();
                        }
                    } else {
                        this.hideSamplingPoints();
                    }
                } catch (error) {
                    console.error('Error loading sampling points:', error);
                    this.hideSamplingPoints();
                }
            }

            populateSamplingPointsDropdown(samplingPoints) {
                const samplingPointSelect = document.getElementById('sampling-point');
                samplingPointSelect.innerHTML = '<option value="">Select a sampling point (optional)...</option>';

                samplingPoints.forEach(point => {
                    const option = document.createElement('option');
                    option.value = point.id;
                    option.textContent = point.name;
                    option.dataset.location = point.location;
                    option.dataset.description = point.description;
                    samplingPointSelect.appendChild(option);
                });
            }

            showSamplingPoints() {
                document.getElementById('sampling-points-section').classList.remove('hidden');
            }

            hideSamplingPoints() {
                document.getElementById('sampling-points-section').classList.add('hidden');
                document.getElementById('sampling-point').value = '';
                document.getElementById('sampling-point-location').textContent = '';
            }

            handleSamplingPointSelection() {
                const samplingPointSelect = document.getElementById('sampling-point');
                const locationSpan = document.getElementById('sampling-point-location');

                if (samplingPointSelect.value) {
                    const selectedOption = samplingPointSelect.options[samplingPointSelect.selectedIndex];
                    const location = selectedOption.dataset.location || 'Not specified';
                    locationSpan.textContent = location;
                } else {
                    locationSpan.textContent = '';
                }
            }

            updateChlorineTotal() {
                if (this.currentSupply && this.currentSupply.type === 'untreated') {
                    return; // Don't calculate for untreated supplies
                }

                const positive = parseInt(document.getElementById('chlorine-positive').value) || 0;
                const negative = parseInt(document.getElementById('chlorine-negative').value) || 0;
                const total = positive + negative;
                document.getElementById('chlorine-total').value = total;
            }

            handleChlorineRangeChange() {
                const positiveRange = document.getElementById('chlorine-positive-range').value;
                const negativeRange = document.getElementById('chlorine-negative-range').value;

                this.updateChlorineStatusForRange('positive', positiveRange);
                this.updateChlorineStatusForRange('negative', negativeRange);
            }

            updateChlorineStatusForRange(type, rangeValue) {
                const elements = {
                    warning: document.getElementById(`chlorine-${type}-warning`),
                    ideal: document.getElementById(`chlorine-${type}-ideal`),
                    maximum: document.getElementById(`chlorine-${type}-maximum`),
                    high: document.getElementById(`chlorine-${type}-high`),
                    veryHigh: document.getElementById(`chlorine-${type}-very-high`)
                };

                // Hide all indicators first
                Object.values(elements).forEach(el => el.style.display = 'none');

                if (!rangeValue) return;

                const numericValue = this.parseRangeValue(rangeValue);
                const isTreatmentSite = this.currentSupply && this.currentSupply.type === 'treated';

                // Apply different logic for treatment sites (2.0-2.5 ideal)
                if (isTreatmentSite && numericValue >= 2.0 && numericValue <= 2.5) {
                    elements.ideal.style.display = 'block';
                } else if (numericValue === 0 || (numericValue >= 0.1 && numericValue <= 0.4)) {
                    // 0, 0.1-0.4: low, action needed
                    elements.warning.style.display = 'block';
                } else if (numericValue >= 0.5 && numericValue <= 1.5) {
                    // 0.5-1.5: ideal level
                    elements.ideal.style.display = 'block';
                } else if (numericValue >= 1.6 && numericValue <= 2.0) {
                    // 1.6-2.0: maximum level
                    elements.maximum.style.display = 'block';
                } else if (numericValue >= 2.1 && numericValue <= 2.4) {
                    // 2.1-2.4: high level--adjust chlorine dosage
                    elements.high.style.display = 'block';
                } else if (numericValue >= 2.5 && (numericValue <= 3.0 || rangeValue === '>3.5')) {
                    // 2.5-3.0, >3.5: very high level --> adjust chlorine dosage
                    elements.veryHigh.style.display = 'block';
                }
            }

            parseRangeValue(rangeStr) {
                // Parse range strings like "<0.2", "0.5", ">3.5" to numeric values
                if (rangeStr.includes('<')) {
                    return parseFloat(rangeStr.replace('<', '')) - 0.01; // Slightly below the threshold
                } else if (rangeStr === '>3.5') {
                    return 4.0; // Represent >3.5 as a high value for comparison
                } else if (rangeStr.includes('>')) {
                    return parseFloat(rangeStr.replace('>', '')) + 0.01; // Slightly above the threshold
                } else {
                    return parseFloat(rangeStr);
                }
            }

            handleBacteriologicalChange() {
                const positiveValue = parseInt(document.getElementById('bacteriological-positive').value) || 0;
                const urgentIcon = document.getElementById('urgent-icon');
                const organismDropdown = document.getElementById('isolated-organism');

                if (positiveValue > 2.9) {
                    urgentIcon.style.display = 'inline';
                } else {
                    urgentIcon.style.display = 'none';
                }

                if (positiveValue > 0) {
                    organismDropdown.style.display = 'inline';
                } else {
                    organismDropdown.style.display = 'none';
                    organismDropdown.value = '';
                }
            }

            validateForm() {
                const errors = [];

                // Check if supply is selected
                const supplyId = document.getElementById('supply').value;
                if (!supplyId) {
                    errors.push('Water Supply');
                }

                // Check submission date
                const submissionDate = document.getElementById('submission-date').value;
                if (!submissionDate) {
                    errors.push('Submission Date');
                }

                // Check number of visits
                const visits = parseInt(document.getElementById('visits').value);
                if (!visits || visits < 1) {
                    errors.push('Number of Visits (must be at least 1)');
                }

                // For treated supplies, check if chlorine range values are selected when counts > 0
                if (this.currentSupply && this.currentSupply.type === 'treated') {
                    const chlorinePositive = parseInt(document.getElementById('chlorine-positive').value) || 0;
                    const chlorineNegative = parseInt(document.getElementById('chlorine-negative').value) || 0;
                    const chlorinePositiveRange = document.getElementById('chlorine-positive-range').value;
                    const chlorineNegativeRange = document.getElementById('chlorine-negative-range').value;

                    if (chlorinePositive > 0 && !chlorinePositiveRange) {
                        errors.push('Chlorine Positive Range (required when count > 0)');
                    }

                    if (chlorineNegative > 0 && !chlorineNegativeRange) {
                        errors.push('Chlorine Negative Range (required when count > 0)');
                    }
                }

                // Check bacteriological fields - at least one should have a value
                const bacterioPositive = parseInt(document.getElementById('bacteriological-positive').value) || 0;
                const bacterioNegative = parseInt(document.getElementById('bacteriological-negative').value) || 0;
                const bacterioPending = parseInt(document.getElementById('bacteriological-pending').value) || 0;

                if (bacterioPositive === 0 && bacterioNegative === 0 && bacterioPending === 0) {
                    errors.push('At least one Bacteriological test result');
                }

                return errors;
            }

            async handleSubmit(event) {
                event.preventDefault();

                // Comprehensive form validation
                const validationErrors = this.validateForm();
                if (validationErrors.length > 0) {
                    this.showAlert('error', 'Please complete all required fields: ' + validationErrors.join(', '));
                    return;
                }

                const submitBtn = document.getElementById('submit-btn');
                const originalText = submitBtn.textContent;

                try {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Submitting...';

                    const formData = new FormData(event.target);
                    const supplyId = parseInt(document.getElementById('supply').value);

                    // For untreated supplies, ensure chlorine values are 0
                    let chlorineTotal = 0;
                    let chlorinePositive = 0;
                    let chlorineNegative = 0;

                    if (this.currentSupply && this.currentSupply.type === 'treated') {
                        chlorineTotal = parseInt(formData.get('chlorine_total')) || 0;
                        chlorinePositive = parseInt(formData.get('chlorine_positive')) || 0;
                        chlorineNegative = parseInt(formData.get('chlorine_negative')) || 0;
                    }

                    const samplingPointId = document.getElementById('sampling-point').value;

                    const data = {
                        supply_id: supplyId,
                        sampling_point_id: samplingPointId ? parseInt(samplingPointId) : null,
                        submission_date: formData.get('submission_date'),
                        visits: parseInt(formData.get('visits')) || 1,
                        chlorine_total: chlorineTotal,
                        chlorine_positive: chlorinePositive,
                        chlorine_negative: chlorineNegative,
                        chlorine_positive_range: document.getElementById('chlorine-positive-range').value,
                        chlorine_negative_range: document.getElementById('chlorine-negative-range').value,
                        bacteriological_positive: parseInt(formData.get('bacteriological_positive')) || 0,
                        bacteriological_negative: parseInt(formData.get('bacteriological_negative')) || 0,
                        bacteriological_pending: parseInt(formData.get('bacteriological_pending')) || 0,
                        isolated_organism: document.getElementById('isolated-organism').value || '',
                        remarks: formData.get('remarks') || '',
                        facility_type: document.getElementById('facility-type').value || ''
                    };

                    if (!data.supply_id) {
                        this.showAlert('error', 'Please select a water supply');
                        return;
                    }

                    const response = await fetch('/api/submit-inspection', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.showAlert('success', `New submission for ${this.currentSupply.name} completed successfully!`);

                        // Reset form for next submission
                        this.resetForm();

                        // Clear supply selection to start fresh
                        document.getElementById('supply').value = '';
                        this.hideForm();

                        // Reload recent submissions
                        await this.loadRecentSubmissions();

                    } else {
                        const error = await response.json();
                        this.showAlert('error', error.message || 'Failed to submit inspection data');
                    }

                } catch (error) {
                    console.error('Error submitting inspection:', error);
                    this.showAlert('error', 'Error connecting to server');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            }

            setupSearchListeners() {
                const searchInput = document.getElementById('search-input');
                const clearButton = document.getElementById('clear-search');
                const suggestionsContainer = document.getElementById('search-suggestions');

                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.trim();
                    clearTimeout(this.searchTimeout);

                    if (query.length === 0) {
                        this.clearSearch();
                        return;
                    }

                    clearButton.style.display = 'block';

                    // Debounce search
                    this.searchTimeout = setTimeout(() => {
                        this.performSearch(query);
                        this.showSuggestions(query);
                    }, 300);
                });

                searchInput.addEventListener('focus', () => {
                    const query = searchInput.value.trim();
                    if (query.length > 0) {
                        this.showSuggestions(query);
                    }
                });

                searchInput.addEventListener('blur', () => {
                    // Delay hiding suggestions to allow for clicks
                    setTimeout(() => {
                        suggestionsContainer.style.display = 'none';
                    }, 200);
                });

                clearButton.addEventListener('click', () => {
                    this.clearSearch();
                });

                // Handle escape key
                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.clearSearch();
                        searchInput.blur();
                    }
                });
            }

            performSearch(query) {
                const lowerQuery = query.toLowerCase();

                this.filteredSubmissions = this.recentSubmissions.filter(submission => {
                    return submission.supply_name.toLowerCase().includes(lowerQuery) ||
                           submission.agency.toLowerCase().includes(lowerQuery) ||
                           (submission.sampling_point_name && submission.sampling_point_name.toLowerCase().includes(lowerQuery)) ||
                           (submission.sampling_point_location && submission.sampling_point_location.toLowerCase().includes(lowerQuery));
                });

                this.displayFilteredSubmissions();
            }

            showSuggestions(query) {
                const suggestionsContainer = document.getElementById('search-suggestions');
                const lowerQuery = query.toLowerCase();

                // Get unique suggestions from submissions
                const suggestions = [];
                const seen = new Set();

                this.recentSubmissions.forEach(submission => {
                    if (submission.supply_name.toLowerCase().includes(lowerQuery)) {
                        const key = `supply_${submission.supply_name}`;
                        if (!seen.has(key)) {
                            seen.add(key);
                            suggestions.push({
                                type: 'supply',
                                name: submission.supply_name,
                                details: `${submission.agency} • ${submission.type}`,
                                value: submission.supply_name
                            });
                        }
                    }

                    if (submission.sampling_point_name && submission.sampling_point_name.toLowerCase().includes(lowerQuery)) {
                        const key = `sampling_${submission.sampling_point_name}`;
                        if (!seen.has(key)) {
                            seen.add(key);
                            suggestions.push({
                                type: 'sampling_point',
                                name: submission.sampling_point_name,
                                details: submission.sampling_point_location || 'Sampling Point',
                                value: submission.sampling_point_name
                            });
                        }
                    }
                });

                // Limit to 5 suggestions
                const limitedSuggestions = suggestions.slice(0, 5);

                if (limitedSuggestions.length === 0) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }

                suggestionsContainer.innerHTML = limitedSuggestions.map(suggestion => `
                    <div class="suggestion-item" onclick="dashboard.selectSuggestion('${suggestion.value.replace(/'/g, "\\'")}')">
                        <div class="suggestion-type">${suggestion.type === 'supply' ? 'Water Supply' : 'Sampling Point'}</div>
                        <div class="suggestion-name">${suggestion.name}</div>
                        <div class="suggestion-details">${suggestion.details}</div>
                    </div>
                `).join('');

                suggestionsContainer.style.display = 'block';
            }

            selectSuggestion(value) {
                const searchInput = document.getElementById('search-input');
                const suggestionsContainer = document.getElementById('search-suggestions');

                searchInput.value = value;
                suggestionsContainer.style.display = 'none';
                this.performSearch(value);
            }

            clearSearch() {
                const searchInput = document.getElementById('search-input');
                const clearButton = document.getElementById('clear-search');
                const suggestionsContainer = document.getElementById('search-suggestions');

                searchInput.value = '';
                clearButton.style.display = 'none';
                suggestionsContainer.style.display = 'none';
                this.filteredSubmissions = [];
                this.displayRecentSubmissions();
            }

            displayFilteredSubmissions() {
                const container = document.getElementById('recent-submissions-list');

                if (this.filteredSubmissions.length === 0) {
                    container.innerHTML = '<div class="no-results">No submissions found matching your search.</div>';
                    return;
                }

                container.innerHTML = this.filteredSubmissions.slice(0, 10).map(submission => `
                    <div class="submission-card">
                        <div class="submission-header">
                            <strong>${submission.supply_name}</strong>
                            <span class="submission-time">${this.formatDateTime(submission.created_at)}</span>
                        </div>
                        <p class="muted-text" style="font-size: 14px; margin-bottom: 0.5rem;">
                            ${submission.agency} • ${submission.type} • ${submission.visits} visit(s)
                            ${submission.sampling_point_name ? `<br><strong>Sampling Point:</strong> ${submission.sampling_point_name}` : ''}
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.5rem; font-size: 12px;">
                            ${submission.type === 'treated' ? `
                                <div>Chlorine: ${submission.chlorine_total}</div>
                                <div class="positive-result">C+: ${submission.chlorine_positive}${submission.chlorine_positive_range ? ` (${submission.chlorine_positive_range})` : ''}</div>
                                <div class="negative-result">C-: ${submission.chlorine_negative}${submission.chlorine_negative_range ? ` (${submission.chlorine_negative_range})` : ''}</div>
                            ` : ''}
                            <div class="positive-result">B+: ${submission.bacteriological_positive}${submission.isolated_organism ? ` (${submission.isolated_organism})` : ''}</div>
                            <div class="negative-result">B-: ${submission.bacteriological_negative}</div>
                            <div style="color: #ffc107;">B Pending: ${submission.bacteriological_pending}</div>
                        </div>
                        ${submission.remarks ? `<p style="margin-top: 0.5rem; font-size: 13px; color: #666;"><strong>Remarks:</strong> ${submission.remarks}</p>` : ''}
                        <div style="margin-top: 1rem; display: flex; gap: 10px;">
                            <button class="view-btn" onclick="dashboard.viewSubmission(${submission.id})" style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">View</button>
                            <button class="download-btn" onclick="dashboard.downloadSubmission(${submission.id})" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Download</button>
                        </div>
                    </div>
                `).join('');
            }

            async loadRecentSubmissions() {
                try {
                    const response = await fetch('/api/my-submissions');
                    if (response.ok) {
                        this.recentSubmissions = await response.json();
                        this.displayRecentSubmissions();
                    }
                } catch (error) {
                    console.error('Error loading recent submissions:', error);
                }
            }

            displayRecentSubmissions() {
                const container = document.getElementById('recent-submissions-list');

                if (this.recentSubmissions.length === 0) {
                    container.innerHTML = '<p class="muted-text" style="text-align: center; padding: 2rem;">No recent submissions found.</p>';
                    return;
                }

                container.innerHTML = this.recentSubmissions.slice(0, 5).map(submission => `
                    <div class="submission-card">
                        <div class="submission-header">
                            <strong>${submission.supply_name}</strong>
                            <span class="submission-time">${this.formatDateTime(submission.created_at)}</span>
                        </div>
                        <p class="muted-text" style="font-size: 14px; margin-bottom: 0.5rem;">
                            ${submission.agency} • ${submission.type} • ${submission.visits} visit(s)
                            ${submission.sampling_point_name ? `<br><strong>Sampling Point:</strong> ${submission.sampling_point_name}` : ''}
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.5rem; font-size: 12px;">
                            ${submission.type === 'treated' ? `
                                <div>Chlorine: ${submission.chlorine_total}</div>
                                <div class="positive-result">C+: ${submission.chlorine_positive}${submission.chlorine_positive_range ? ` (${submission.chlorine_positive_range})` : ''}</div>
                                <div class="negative-result">C-: ${submission.chlorine_negative}${submission.chlorine_negative_range ? ` (${submission.chlorine_negative_range})` : ''}</div>
                            ` : ''}
                            <div class="positive-result">B+: ${submission.bacteriological_positive}${submission.isolated_organism ? ` (${submission.isolated_organism})` : ''}</div>
                            <div class="negative-result">B-: ${submission.bacteriological_negative}</div>
                            <div style="color: #ffc107;">B Pending: ${submission.bacteriological_pending}</div>
                        </div>
                        ${submission.remarks ? `<p style="margin-top: 0.5rem; font-size: 13px; color: #666;"><strong>Remarks:</strong> ${submission.remarks}</p>` : ''}
                        <div style="margin-top: 1rem; display: flex; gap: 10px;">
                            <button class="view-btn" onclick="dashboard.viewSubmission(${submission.id})" style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">View</button>
                            <button class="download-btn" onclick="dashboard.downloadSubmission(${submission.id})" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Download</button>
                        </div>
                    </div>
                `).join('');
            }

            showFuturisticWaterModal(message) {
                const waterModal = document.getElementById('waterModal');
                const waterModalMessage = document.getElementById('waterModalMessage');

                // Set timestamp
                const now = new Date();
                const timestamp = now.toLocaleTimeString('en-US', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                document.getElementById('analysis-timestamp').textContent = timestamp;

                // Get form data for analysis summary
                const chlorinePositive = parseInt(document.getElementById('chlorine-positive').value) || 0;
                const chlorineNegative = parseInt(document.getElementById('chlorine-negative').value) || 0;
                const bacteriaPositive = parseInt(document.getElementById('bacteriological-positive').value) || 0;
                const bacteriaNegative = parseInt(document.getElementById('bacteriological-negative').value) || 0;

                // Update chlorine analysis summary
                const chlorineTotal = chlorinePositive + chlorineNegative;
                let chlorineSummary = 'NO DATA';
                if (chlorineTotal > 0) {
                    if (this.currentSupply && this.currentSupply.type === 'treated') {
                        chlorineSummary = `${chlorineTotal} SAMPLES ANALYZED`;
                    } else {
                        chlorineSummary = 'N/A - UNTREATED SUPPLY';
                    }
                }
                document.getElementById('chlorine-summary').textContent = chlorineSummary;

                // Update bacteria analysis summary
                const bacteriaTotal = bacteriaPositive + bacteriaNegative;
                let bacteriaSummary = 'NO DATA';
                if (bacteriaTotal > 0) {
                    if (bacteriaPositive > 0) {
                        bacteriaSummary = `${bacteriaTotal} SAMPLES - ${bacteriaPositive} POSITIVE DETECTED`;
                    } else {
                        bacteriaSummary = `${bacteriaTotal} SAMPLES - ALL NEGATIVE`;
                    }
                }
                document.getElementById('bacteria-summary').textContent = bacteriaSummary;

                // Update supply status
                const supplyName = this.currentSupply ? this.currentSupply.name : 'UNKNOWN';
                document.getElementById('supply-summary').textContent = `${supplyName} - ACTIVE`;

                // Set main message
                waterModalMessage.textContent = 'INSPECTION DATA SUCCESSFULLY TRANSMITTED TO CENTRAL DATABASE';

                // Show modal with smooth fade-in animation
                waterModal.style.display = 'flex';
                setTimeout(() => {
                    waterModal.classList.add('show');
                }, 10);
            }

            showAlert(type, message) {
                if (type === 'success') {
                    // Use water modal for success messages with futuristic data
                    this.showFuturisticWaterModal(message);
                } else {
                    // Use regular alert for error messages
                    const alertContainer = document.getElementById('alert-container');
                    const alertClass = 'alert-error';

                    alertContainer.innerHTML = `
                        <div class="alert ${alertClass}">
                            ${message}
                        </div>
                    `;

                    // Auto-hide alert after 5 seconds
                    setTimeout(() => {
                        alertContainer.innerHTML = '';
                    }, 5000);

                    // Scroll to top to show alert
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }

            formatDateTime(dateString) {
                const date = new Date(dateString);
                return date.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            async viewSubmission(submissionId) {
                try {
                    const response = await fetch(`/api/submission/${submissionId}`);
                    if (response.ok) {
                        const submission = await response.json();
                        this.showSubmissionDetails(submission);
                    } else {
                        this.showAlert('error', 'Failed to load submission details');
                    }
                } catch (error) {
                    console.error('Error loading submission:', error);
                    this.showAlert('error', 'Error loading submission details');
                }
            }

            async downloadSubmission(submissionId) {
                try {
                    const response = await fetch(`/api/submission/${submissionId}/download`);
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `water_quality_submission_${submissionId}.html`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        this.showAlert('success', 'Submission downloaded successfully!');
                    } else {
                        this.showAlert('error', 'Failed to download submission');
                    }
                } catch (error) {
                    console.error('Error downloading submission:', error);
                    this.showAlert('error', 'Error downloading submission');
                }
            }

            showSubmissionDetails(submission) {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                `;

                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    border-radius: 10px;
                    max-width: 800px;
                    width: 100%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
                `;

                content.innerHTML = `
                    <div style="padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 2px solid #eee; padding-bottom: 1rem;">
                            <h2 style="color: #333; margin: 0;">Water Quality Inspection Details</h2>
                            <button onclick="this.closest('.modal').remove()" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">Close</button>
                        </div>

                        <div style="background: #e3f2fd; padding: 1rem; border-radius: 5px; margin-bottom: 1.5rem; border-left: 4px solid #667eea;">
                            <h3 style="color: #333; font-size: 18px; margin-bottom: 0.5rem;">${submission.supply_name}</h3>
                            <p style="color: #666; margin: 0;">${submission.agency} • ${submission.type.charAt(0).toUpperCase() + submission.type.slice(1)} Supply</p>
                            ${submission.sampling_point_name ? `<p style="color: #666; margin: 0;"><strong>Sampling Point:</strong> ${submission.sampling_point_name} ${submission.sampling_point_location ? `(${submission.sampling_point_location})` : ''}</p>` : ''}
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px;">
                                <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 600;">Submission Date</label>
                                <div style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: white; color: #000; font-weight: bold;">${submission.submission_date}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px;">
                                <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 600;">Number of Visits</label>
                                <div style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: white; color: #000; font-weight: bold;">${submission.visits}</div>
                            </div>
                        </div>

                        ${submission.type === 'treated' ? `
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
                            <h3 style="color: #333; margin-bottom: 1rem; font-size: 16px;">Chlorine Residual Tests</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 600;">Total Tests</label>
                                    <div style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: #f8f9fa; color: #000; font-weight: bold;">${submission.chlorine_total}</div>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 600;">Positive</label>
                                    <div style="padding: 10px; border: 1px solid #28a745; border-radius: 5px; background: #d4edda; color: #000; font-weight: bold;">${submission.chlorine_positive}</div>
                                    ${submission.chlorine_positive_range ? `<small style="color: #28a745; font-weight: bold;">Range: ${submission.chlorine_positive_range}</small>` : ''}
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 600;">Negative</label>
                                    <div style="padding: 10px; border: 1px solid #dc3545; border-radius: 5px; background: #f8d7da; color: #000; font-weight: bold;">${submission.chlorine_negative}</div>
                                    ${submission.chlorine_negative_range ? `<small style="color: #dc3545; font-weight: bold;">Range: ${submission.chlorine_negative_range}</small>` : ''}
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
                            <h3 style="color: #333; margin-bottom: 1rem; font-size: 16px;">Bacteriological Tests</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 600;">Positive</label>
                                    <div style="padding: 10px; border: 1px solid #28a745; border-radius: 5px; background: #d4edda; color: #000; font-weight: bold;">${submission.bacteriological_positive}</div>
                                    ${submission.isolated_organism ? `<small style="color: #28a745; font-weight: bold;">Organism: ${submission.isolated_organism}</small>` : ''}
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 600;">Negative</label>
                                    <div style="padding: 10px; border: 1px solid #dc3545; border-radius: 5px; background: #f8d7da; color: #000; font-weight: bold;">${submission.bacteriological_negative}</div>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 600;">Result Pending</label>
                                    <div style="padding: 10px; border: 1px solid #ffc107; border-radius: 5px; background: #fff3cd; color: #000; font-weight: bold;">${submission.bacteriological_pending}</div>
                                </div>
                            </div>
                        </div>

                        ${submission.remarks ? `
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 600;">Remarks</label>
                            <div style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: white; min-height: 60px; color: #000; font-weight: bold;">${submission.remarks}</div>
                        </div>
                        ` : ''}

                        <div style="text-align: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #eee;">
                            <small style="color: #666;">Submitted on ${this.formatDateTime(submission.created_at)}</small>
                        </div>
                    </div>
                `;

                modal.className = 'modal';
                modal.appendChild(content);
                document.body.appendChild(modal);

                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }

            // ================================
            // TASK MANAGEMENT METHODS
            // ================================

            async loadAssignedTasks() {
                try {
                    const response = await fetch('/api/inspector/tasks');
                    if (response.ok) {
                        this.assignedTasks = await response.json();
                        this.filterTasks(this.currentFilter);
                        this.updateTaskBadge();
                    } else if (response.status === 404) {
                        // No tasks found, use demo data
                        this.assignedTasks = this.getDemoTasks();
                        this.filterTasks(this.currentFilter);
                        this.updateTaskBadge();
                    } else {
                        throw new Error('Failed to load tasks');
                    }
                } catch (error) {
                    console.error('Error loading assigned tasks:', error);
                    // Load demo tasks as fallback
                    this.assignedTasks = this.getDemoTasks();
                    this.filterTasks(this.currentFilter);
                    this.updateTaskBadge();
                }
            }

            getDemoTasks() {
                return [
                    {
                        id: 1,
                        title: 'Chlorine Level Check - Roaring River 1',
                        description: 'Conduct routine chlorine residual testing at Roaring River 1 water supply. Check levels at 3 different sampling points and document any irregularities.',
                        supply_name: 'Roaring River 1',
                        supply_type: 'treated',
                        priority: 'High',
                        due_date: '2024-12-22T14:00:00',
                        status: 'pending',
                        assigned_date: '2024-12-19T09:30:00',
                        assigned_by: 'Admin User'
                    },
                    {
                        id: 2,
                        title: 'Monthly Bacteriological Test - Bulstrode',
                        description: 'Perform monthly bacteriological testing for Bulstrode water supply. Collect samples from main source and two distribution points.',
                        supply_name: 'Bulstrode',
                        supply_type: 'untreated',
                        priority: 'Medium',
                        due_date: '2024-12-25T10:00:00',
                        status: 'accepted',
                        assigned_date: '2024-12-18T15:20:00',
                        assigned_by: 'Admin User'
                    },
                    {
                        id: 3,
                        title: 'Routine Inspection - Cave Supply',
                        description: 'Complete comprehensive inspection of Cave water supply including infrastructure assessment and water quality testing.',
                        supply_name: 'Cave',
                        supply_type: 'untreated',
                        priority: 'Low',
                        due_date: '2024-12-28T11:00:00',
                        status: 'in_progress',
                        assigned_date: '2024-12-17T11:45:00',
                        assigned_by: 'Admin User'
                    }
                ];
            }

            setupTaskFilters() {
                const filterTabs = document.querySelectorAll('.filter-tab');
                filterTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        // Remove active class from all tabs
                        filterTabs.forEach(t => t.classList.remove('active'));
                        // Add active class to clicked tab
                        tab.classList.add('active');

                        const filter = tab.dataset.filter;
                        this.currentFilter = filter;
                        this.filterTasks(filter);
                    });
                });
            }

            filterTasks(filter) {
                if (filter === 'all') {
                    this.filteredTasks = this.assignedTasks;
                } else {
                    this.filteredTasks = this.assignedTasks.filter(task => task.status === filter);
                }
                this.displayTasks();
            }

            displayTasks() {
                const container = document.getElementById('tasks-container');

                if (this.filteredTasks.length === 0) {
                    const filterText = this.currentFilter === 'all' ? 'tasks' : `${this.currentFilter} tasks`;
                    container.innerHTML = `<div class="no-tasks">No ${filterText} found.</div>`;
                    return;
                }

                container.innerHTML = this.filteredTasks.map(task => this.createTaskCard(task)).join('');
            }

            createTaskCard(task) {
                const priorityClass = task.priority.toLowerCase();
                const statusClass = task.status.toLowerCase();
                const isOverdue = new Date(task.due_date) < new Date() && task.status !== 'completed';

                return `
                    <div class="task-card ${priorityClass}">
                        <div class="task-status ${statusClass}">${task.status.replace('_', ' ')}</div>

                        <div class="task-header">
                            <div>
                                <h3 class="task-title">${task.title}</h3>
                                <div class="task-priority ${priorityClass}">${task.priority}</div>
                            </div>
                        </div>

                        <div class="task-description">
                            ${task.description}
                        </div>

                        <div class="task-details">
                            <div class="task-detail">
                                <strong>💧 Water Supply:</strong> ${task.supply_name} (${task.supply_type})
                            </div>
                            <div class="task-detail">
                                <strong>📅 Due Date:</strong> ${this.formatDateTime(task.due_date)}
                                ${isOverdue ? '<span style="color: #dc3545; font-weight: bold;"> (OVERDUE)</span>' : ''}
                            </div>
                            <div class="task-detail">
                                <strong>👤 Assigned By:</strong> ${task.assigned_by}
                            </div>
                            <div class="task-detail">
                                <strong>📝 Assigned:</strong> ${this.formatDateTime(task.assigned_date)}
                            </div>
                        </div>

                        <div class="task-actions">
                            ${this.getTaskActionButtons(task)}
                        </div>
                    </div>
                `;
            }

            getTaskActionButtons(task) {
                switch (task.status) {
                    case 'pending':
                        return `
                            <button class="task-btn accept" onclick="dashboard.acceptTask(${task.id})">✅ Accept Task</button>
                            <button class="task-btn reject" onclick="dashboard.rejectTask(${task.id})">❌ Reject Task</button>
                            <button class="task-btn view" onclick="dashboard.viewTaskDetails(${task.id})">👁️ View Details</button>
                        `;
                    case 'accepted':
                        return `
                            <button class="task-btn complete" onclick="dashboard.startTask(${task.id})">🚀 Start Task</button>
                            <button class="task-btn view" onclick="dashboard.viewTaskDetails(${task.id})">👁️ View Details</button>
                        `;
                    case 'in_progress':
                        return `
                            <button class="task-btn complete" onclick="dashboard.completeTask(${task.id})">✅ Mark Complete</button>
                            <button class="task-btn view" onclick="dashboard.viewTaskDetails(${task.id})">👁️ View Details</button>
                        `;
                    case 'completed':
                        return `
                            <button class="task-btn view" onclick="dashboard.viewTaskDetails(${task.id})">👁️ View Details</button>
                        `;
                    case 'rejected':
                        return `
                            <button class="task-btn view" onclick="dashboard.viewTaskDetails(${task.id})">👁️ View Details</button>
                        `;
                    default:
                        return `
                            <button class="task-btn view" onclick="dashboard.viewTaskDetails(${task.id})">👁️ View Details</button>
                        `;
                }
            }

            async acceptTask(taskId) {
                try {
                    const response = await fetch(`/api/inspector/tasks/${taskId}/accept`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (response.ok) {
                        // Update task status locally
                        const task = this.assignedTasks.find(t => t.id === taskId);
                        if (task) {
                            task.status = 'accepted';
                        }
                        this.filterTasks(this.currentFilter);
                        this.updateTaskBadge();
                        this.showTaskNotification('Task accepted successfully! 🎉', 'success');
                    } else {
                        throw new Error('Failed to accept task');
                    }
                } catch (error) {
                    console.error('Error accepting task:', error);
                    // For demo, still update locally
                    const task = this.assignedTasks.find(t => t.id === taskId);
                    if (task) {
                        task.status = 'accepted';
                    }
                    this.filterTasks(this.currentFilter);
                    this.updateTaskBadge();
                    this.showTaskNotification('Task accepted successfully! 🎉', 'success');
                }
            }

            async rejectTask(taskId) {
                const reason = prompt('Please provide a reason for rejecting this task:');
                if (!reason) return;

                try {
                    const response = await fetch(`/api/inspector/tasks/${taskId}/reject`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ reason })
                    });

                    if (response.ok) {
                        // Update task status locally
                        const task = this.assignedTasks.find(t => t.id === taskId);
                        if (task) {
                            task.status = 'rejected';
                            task.rejection_reason = reason;
                        }
                        this.filterTasks(this.currentFilter);
                        this.updateTaskBadge();
                        this.showTaskNotification('Task rejected. Reason has been sent to admin.', 'info');
                    } else {
                        throw new Error('Failed to reject task');
                    }
                } catch (error) {
                    console.error('Error rejecting task:', error);
                    // For demo, still update locally
                    const task = this.assignedTasks.find(t => t.id === taskId);
                    if (task) {
                        task.status = 'rejected';
                        task.rejection_reason = reason;
                    }
                    this.filterTasks(this.currentFilter);
                    this.updateTaskBadge();
                    this.showTaskNotification('Task rejected. Reason has been sent to admin.', 'info');
                }
            }

            async startTask(taskId) {
                try {
                    const response = await fetch(`/api/inspector/tasks/${taskId}/start`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (response.ok) {
                        // Update task status locally
                        const task = this.assignedTasks.find(t => t.id === taskId);
                        if (task) {
                            task.status = 'in_progress';
                        }
                        this.filterTasks(this.currentFilter);
                        this.showTaskNotification('Task started! Good luck with your inspection. 💪', 'success');
                    } else {
                        throw new Error('Failed to start task');
                    }
                } catch (error) {
                    console.error('Error starting task:', error);
                    // For demo, still update locally
                    const task = this.assignedTasks.find(t => t.id === taskId);
                    if (task) {
                        task.status = 'in_progress';
                    }
                    this.filterTasks(this.currentFilter);
                    this.showTaskNotification('Task started! Good luck with your inspection. 💪', 'success');
                }
            }

            async completeTask(taskId) {
                const confirmed = confirm('Are you sure you want to mark this task as completed? Make sure you have submitted all required inspection data.');
                if (!confirmed) return;

                try {
                    const response = await fetch(`/api/inspector/tasks/${taskId}/complete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (response.ok) {
                        // Update task status locally
                        const task = this.assignedTasks.find(t => t.id === taskId);
                        if (task) {
                            task.status = 'completed';
                            task.completed_date = new Date().toISOString();
                        }
                        this.filterTasks(this.currentFilter);
                        this.showTaskNotification('Task completed successfully! 🏆', 'success');
                    } else {
                        throw new Error('Failed to complete task');
                    }
                } catch (error) {
                    console.error('Error completing task:', error);
                    // For demo, still update locally
                    const task = this.assignedTasks.find(t => t.id === taskId);
                    if (task) {
                        task.status = 'completed';
                        task.completed_date = new Date().toISOString();
                    }
                    this.filterTasks(this.currentFilter);
                    this.showTaskNotification('Task completed successfully! 🏆', 'success');
                }
            }

            viewTaskDetails(taskId) {
                const task = this.assignedTasks.find(t => t.id === taskId);
                if (!task) return;

                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0, 0, 0, 0.5); z-index: 1000;
                    display: flex; align-items: center; justify-content: center; padding: 20px;
                `;

                const content = document.createElement('div');
                content.style.cssText = `
                    background: white; border-radius: 10px; max-width: 600px; width: 100%;
                    max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
                `;

                const priorityClass = task.priority.toLowerCase();
                const statusClass = task.status.toLowerCase();
                const isOverdue = new Date(task.due_date) < new Date() && task.status !== 'completed';

                content.innerHTML = `
                    <div style="padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 2px solid #eee; padding-bottom: 1rem;">
                            <h2 style="color: #333; margin: 0;">Task Details</h2>
                            <button onclick="this.closest('.modal').remove()" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">Close</button>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: #333; font-size: 20px; margin-bottom: 0.5rem;">${task.title}</h3>
                            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 1rem;">
                                <span class="task-priority ${priorityClass}" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; text-transform: uppercase;">${task.priority}</span>
                                <span class="task-status ${statusClass}" style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; text-transform: uppercase;">${task.status.replace('_', ' ')}</span>
                                ${isOverdue ? '<span style="color: #dc3545; font-weight: bold; font-size: 12px;">⚠️ OVERDUE</span>' : ''}
                            </div>
                        </div>

                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin-bottom: 1.5rem;">
                            <h4 style="color: #333; margin-bottom: 0.5rem;">Description</h4>
                            <p style="color: #666; line-height: 1.5; margin: 0;">${task.description}</p>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px;">
                                <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 600;">Water Supply</label>
                                <div style="color: #666;">${task.supply_name}</div>
                                <small style="color: #999;">Type: ${task.supply_type}</small>
                            </div>
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px;">
                                <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 600;">Due Date</label>
                                <div style="color: #666;">${this.formatDateTime(task.due_date)}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px;">
                                <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 600;">Assigned By</label>
                                <div style="color: #666;">${task.assigned_by}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px;">
                                <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 600;">Assigned Date</label>
                                <div style="color: #666;">${this.formatDateTime(task.assigned_date)}</div>
                            </div>
                        </div>

                        ${task.rejection_reason ? `
                        <div style="background: #f8d7da; padding: 1rem; border-radius: 5px; margin-bottom: 1.5rem; border-left: 4px solid #dc3545;">
                            <h4 style="color: #721c24; margin-bottom: 0.5rem;">Rejection Reason</h4>
                            <p style="color: #721c24; margin: 0;">${task.rejection_reason}</p>
                        </div>
                        ` : ''}

                        ${task.completed_date ? `
                        <div style="background: #d4edda; padding: 1rem; border-radius: 5px; margin-bottom: 1.5rem; border-left: 4px solid #28a745;">
                            <h4 style="color: #155724; margin-bottom: 0.5rem;">Completed</h4>
                            <p style="color: #155724; margin: 0;">Task completed on ${this.formatDateTime(task.completed_date)}</p>
                        </div>
                        ` : ''}

                        <div style="text-align: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #eee;">
                            <div class="task-actions" style="justify-content: center;">
                                ${this.getTaskActionButtons(task)}
                            </div>
                        </div>
                    </div>
                `;

                modal.className = 'modal';
                modal.appendChild(content);
                document.body.appendChild(modal);

                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }

            showTaskNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = 'task-notification';

                const colors = {
                    'success': { bg: '#28a745', text: 'white' },
                    'error': { bg: '#dc3545', text: 'white' },
                    'info': { bg: '#667eea', text: 'white' },
                    'warning': { bg: '#ffc107', text: '#333' }
                };

                const color = colors[type] || colors.info;
                notification.style.background = color.bg;
                notification.style.color = color.text;
                notification.textContent = message;
                notification.style.display = 'block';

                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.animation = 'slideInTask 0.3s ease-out reverse';
                    setTimeout(() => notification.remove(), 300);
                }, 4000);
            }

            updateTaskBadge() {
                const badge = document.getElementById('taskBadge');
                const pendingTasks = this.assignedTasks.filter(task => task.status === 'pending').length;

                if (pendingTasks > 0) {
                    badge.textContent = pendingTasks;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }

            // Method to simulate receiving a new task (for testing)
            simulateNewTask() {
                const newTask = {
                    id: Date.now(),
                    title: 'Emergency Water Quality Check',
                    description: 'Urgent inspection required due to reported contamination.',
                    supply_name: 'Test Supply',
                    supply_type: 'treated',
                    priority: 'Urgent',
                    due_date: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                    status: 'pending',
                    assigned_date: new Date().toISOString(),
                    assigned_by: 'Admin User'
                };

                this.assignedTasks.unshift(newTask);
                this.updateTaskBadge();
                this.showTaskNotification('New task assigned! 📋', 'info');
            }
        }

        // Global functions
        function incrementVisits() {
            const visitsInput = document.getElementById('visits');
            const currentVisits = parseInt(visitsInput.value) || 0;
            visitsInput.value = currentVisits + 1;
        }

        // Global dashboard instance
        let dashboard;

        // Initialize the dashboard when the DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize theme manager first
            const themeManager = new ThemeManager();
            themeManager.init();

            // Then initialize dashboard
            dashboard = new InspectorDashboard();
        });
    </script>

    <!-- Task Management Modal -->
    <div id="tasksModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000;">
        <div class="modal-content" style="position: absolute; top: 20px; right: 20px; width: 400px; max-height: 80vh; background: var(--container-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--container-border); border-radius: 10px; box-shadow: 0 10px 25px var(--shadow-color);">
            <div style="padding: 1.5rem;">
                <h2 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">📋 Assigned Tasks</h2>

                <div class="filter-tabs" style="margin-bottom: 15px;">
                    <div class="filter-tab active" data-filter="all" style="padding: 4px 8px; font-size: 12px;">All</div>
                    <div class="filter-tab" data-filter="pending" style="padding: 4px 8px; font-size: 12px;">Pending</div>
                    <div class="filter-tab" data-filter="accepted" style="padding: 4px 8px; font-size: 12px;">Accepted</div>
                    <div class="filter-tab" data-filter="in_progress" style="padding: 4px 8px; font-size: 12px;">In Progress</div>
                    <div class="filter-tab" data-filter="completed" style="padding: 4px 8px; font-size: 12px;">Done</div>
                </div>

                <div id="tasks-container" style="max-height: 50vh; overflow-y: auto; margin-bottom: 15px;">
                    <!-- Tasks will be loaded here -->
                    <div class="no-tasks">Loading assigned tasks...</div>
                </div>

                <!-- Close button at the bottom -->
                <div style="text-align: center; padding-top: 15px; border-top: 1px solid #eee;">
                    <button onclick="closeTasksModal()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; font-size: 14px; font-weight: 600; cursor: pointer;">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Task modal functions
        function openTasksModal() {
            const modal = document.getElementById('tasksModal');
            modal.style.display = 'flex';
            // Load tasks when modal opens
            if (window.dashboard) {
                dashboard.loadAssignedTasks();
            }
        }

        function closeTasksModal() {
            const modal = document.getElementById('tasksModal');
            modal.style.display = 'none';
        }

        function closeWaterModal() {
            const modal = document.getElementById('waterModal');
            modal.style.display = 'none';
        }

        function closeWaterModalWithFade() {
            const modal = document.getElementById('waterModal');
            const container = document.querySelector('.container');

            // Fade out modal
            modal.classList.remove('show');

            setTimeout(() => {
                modal.style.display = 'none';

                // Fade in dashboard
                if (container) {
                    container.style.opacity = '0.3';
                    container.style.transition = 'opacity 0.8s ease';
                    setTimeout(() => {
                        container.style.opacity = '1';
                    }, 100);
                }
            }, 400);
        }

        // Add event listener for the Assigned Tasks button
        document.addEventListener('DOMContentLoaded', function() {
            const assignedTasksBtn = document.getElementById('assignedTasksBtn');
            if (assignedTasksBtn) {
                assignedTasksBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    openTasksModal();
                });
            }

            // Close modal when clicking outside
            const modal = document.getElementById('tasksModal');
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeTasksModal();
                }
            });
        });
    </script>
</body>
</html>